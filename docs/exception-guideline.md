- Table of Content
{:toc}

# 例外のガイドライン

- どんな例外をスローすればいい？
- 例外メッセージはどうする？
- どこでキャッチしてエラーログ出力すべき？
- カスタム例外は作るほうがいい？

例外のスローあるいはキャッチの際、こうした判断に迷うことがある。

本ガイドラインは、筆者の過去の経験や知識に基づいた指針を整理したものである。

## 例外の分類

「例外」と一口に言っても範囲が広いため、次の3種類に分類すると、例外のスローやキャッチの判断がしやすくなる。  
この分類は「契約プログラミング」や「技術的例外とビジネス例外」を参考にしたものである。

- **システム例外（違反）**  
  事前条件の違反。クラスやメソッドの使い方やデータの誤り。原則コード修正が必要。ただし、プログラム外のデータ由来ならエラー処理で対応する。  
  例：`ArgumentException`（.NET）、`InvalidArgumentException`（PHP）

- **システム例外（環境）**  
  実行時におけるプログラム外の環境要因の不確実性（ネットワーク、外部API、ファイルシステムなど）。発生自体を制御できない。  
  例：`HttpClientException`、`OutOfMemoryException`（.NET）  
  ※ この種の例外の中には、言語によっては例外とは別枠のエラーとして扱われるものもある（例：メモリ不足）

- **ビジネス例外**  
  在庫切れや利用制限、支払残高不足、認証・認可エラーのような例外。多くの場合、アプリケーション固有の例外をスローする。  
  例：特になし（アプリケーションごとに定義されるため）

※ 検査例外／非検査例外という分類はJava特有であり例外を考えるうえで重要ではない。

## 例外スローの方針

### システム例外（違反）

次の5つでだいたい対応できる。

- メソッドの引数が誤り  
  - .NET：`ArgumentException` またはその派生
  - PHP：`InvalidArgumentException`

- 実装していない処理  
  - .NET：`NotImplementedException`
  - PHP：`LogicException` またはその派生カスタム例外

- サポートしていない処理  
  - .NET：`NotSupportedException`
  - PHP：`LogicException` またはその派生カスタム例外

- メソッド実行時にオブジェクトの状態が不適切  
  - .NET：`InvalidOperationException`
  - PHP：`UnexpectedValueException`

- メソッド実行時に想定外の値  
  - .NET：明確な該当クラスはないが、「〇〇はサポートされていない」と考えるなら `NotSupportedException` が妥当
  - PHP：`UnexpectedValueException`  
  ※ ただし、プログラム外のデータ由来であれば、プログラム側では修正できないため呼び出し元でエラー処理が必要

※ `NullReferenceException` や `IndexOutOfRangeException` のような例外は、基本的にランタイムやライブラリがスローするものであり、アプリケーションコード側でスローする必要はない。

### システム例外（環境）

- 基本的に、言語ランタイムやライブラリがスローするものであり、アプリケーションコードでスローする必要はない。
- ただし、ライブラリがエラーを検出しても例外をスローしない場合など、必要に応じてアプリケーション側でスローしてよい。  
  例：API実行でエラー（ステータス 500）の `Response` クラスのインスタンスが返ってくる場合

### ビジネス例外

業務ロジックに基づき、状況に応じたカスタム例外を定義・スローする。  
ただし、認証や認可など汎用的な機能については、フレームワークやライブラリで定義済みの例外（例：`AuthenticationException`）があればそれを利用する。

- 在庫切れ：`OutOfStockException`
- 利用制限：`UsageRestrictedException`
- 支払残高不足：`InsufficientBalanceException`
- 認証エラー：`AuthenticationException`
- その他：業務要件に応じたカスタム例外を適宜定義

### 例外メッセージの記述指針

- 原因がすぐわかる具体的な情報を含める（例：入力値、状態、識別子など）
  - 具体的で原因が明確なメッセージ例：  
    `The file report-20250101.pdf is not found.`
  - コンテキストデータを JSON 化して含める例：  
    `The file is not found. - {"filename": "report-20250101.pdf"}`

- 例外メッセージは多言語化しない。英語、またはチーム共通の言語を使用する

### 再スロー

- 他の例外をラップして再スローする場合は、元の例外を内部例外として含める（多くの言語でコンストラクタで指定可能）
- ラップせずに再スローする場合は、言語に再スロー構文（例：`throw;`）があるならそれを使う

## 例外キャッチの方針

- 基本的にアプリケーションコードではキャッチしない（共通エラー処理で一括ハンドリング）
- リソース開放が必要であればキャッチして再スロー（`finally` が使える言語では `finally` で開放を行う）
- システム例外は、共通エラー処理（グローバル例外ハンドラ）でキャッチし、ロギング・通知・エラーレスポンス生成を行う
- ビジネス例外は、コントローラなどでキャッチし、ロギング・通知・適切なユーザー向けレスポンスの生成を行う

## カスタム例外

- システム例外については、基本的に言語・フレームワーク・ライブラリで提供されている例外を使うべきで、カスタム例外を設ける必要はあまりない
- ビジネス例外は、その状況に応じてカスタム例外を定義するべき
- ビジネス例外は、共通の基底クラス（例：`BusinessException`）を定義し、個別の例外はそれを継承するとよい
